<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ - Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sky-main: #0ea5e9; --sky-light: #f0f9ff; --sky-dark: #0369a1; --absent: #ef4444; --wa-green: #25D366; --edit: #f59e0b; --sms-blue: #3b82f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--sky-light); margin: 0; padding: 10px; padding-bottom: 80px; direction: rtl; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--sky-main); }
        .nav-link { color: var(--sky-dark); cursor: pointer; font-weight: bold; font-size: 13px; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--sky-main); background: #fff; }
        .section { display: none; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; box-sizing: border-box; }
        .btn { background: var(--sky-dark); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 15px; margin-top: 5px; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 12px; margin: 2px; border-radius: 8px; cursor: pointer; border: none; color: white; }
        .btn-green { background: var(--wa-green); }
        .btn-red { background: var(--absent); }
        .btn-orange { background: var(--edit); }
        .box-blue { background: #f0f9ff; padding: 15px; border-radius: 15px; border: 1px solid #bae6fd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f8fafc; color: var(--sky-dark); }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .student-card { padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; text-align: center; cursor: pointer; background: white; }
        .student-card.selected { background: #fee2e2; border-color: var(--absent); color: var(--absent); font-weight: bold; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; padding: 12px 0; text-align: center; font-size: 14px; z-index: 1000; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <span class="nav-link" onclick="accessControl('admin')">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
        <h2 style="margin:0; color:var(--sky-dark); font-size: 18px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h2>
        <span class="nav-link" onclick="accessControl('home')">ğŸ“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
    </header>

    <div id="syncStatus" style="text-align: center; font-size: 11px; font-weight: bold; margin-bottom: 10px; color: #0369a1;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>

    <div id="loginPage" class="section active" style="text-align: center;">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="max-width:250px"><br>
        <button class="btn" style="max-width:250px" onclick="verifyAccess()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="home" class="section">
        <h3 id="dayDisplay">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
        <select id="classSel" onchange="renderStudents()"></select>
        <div id="gridArea"></div>
        <div id="footerAction" style="display:none;">
            <button class="btn" onclick="saveAbsenceOnly()">Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ â˜ï¸</button>
        </div>
    </div>

    <div id="admin" class="section">
        
        <div class="box-blue">
            <h4 style="margin-top:0;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØµÙÙˆÙ</h4>
            <div style="display: flex; gap: 5px;">
                <select id="manageClassSel" onchange="renderManageTable()" style="flex: 2;"></select>
                <button class="btn-sm btn-red" onclick="deleteWholeClass()" style="flex: 1;">Ø­Ø°Ù Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
            </div>
            <div id="manageTableArea" style="overflow-x: auto;"></div>
        </div>

        <div class="box-blue">
            <h4>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h4>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-sm btn-orange" onclick="renderChart('week')">Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="btn-sm btn-orange" onclick="renderChart('month')">Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø´Ù‡Ø±</button>
            </div>
            <canvas id="absChart" style="max-height: 250px;"></canvas>
        </div>

        <div class="box-blue">
            <h4>ğŸ“ˆ ÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ (Ø¹Ø±Ø¶ ÙˆØ­Ø°Ù Ø£ÙŠØ§Ù…)</h4>
            <select id="reportClassSel" onchange="generateClassReport()"></select>
            <div id="classReportArea"></div>
        </div>

        <div class="box-blue">
            <h4>ğŸ“¬ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© (ÙˆØ§ØªØ³Ø§Ø¨ / SMS)</h4>
            <input type="date" id="historyDateSelector" onchange="loadAdminMessenger()">
            <div id="adminMessenger"></div>
        </div>

        <div class="box-blue">
            <h4>â• Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="newClsName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <textarea id="bulkPaste" rows="3" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§ (Ø§Ù„Ø§Ø³Ù… Ø«Ù… Ø§Ù„Ø±Ù‚Ù…)..."></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="addBulk()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ</button>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ” Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²</h4>
            <input type="text" id="teacherPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="adminPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
            <textarea id="msgTemplate" rows="2" placeholder="Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="updateSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>
</div>

<footer>Ø¥Ø´Ø±Ø§Ù: <strong>Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ</strong></footer>

<script>
    const cloudURL = "https://script.google.com/macros/s/AKfycbz21Hf8IdV6w4sIXXEo3ajFdKon173UO2-iXBu1g5lAY2qsFF8-u_8VqHrJMV-bgrINnA/exec"; 
    
    let db = JSON.parse(localStorage.getItem('abs_v_pro_manage')) || { 
        classes: {}, adminPin: "1122", teacherPin: "1234", archive: [],
        template: "Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨: [name] Ø§Ù„ÙŠÙˆÙ…."
    };

    let myChart = null;

    // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ---
    async function syncToCloud() {
        document.getElementById('syncStatus').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©...";
        try {
            await fetch(cloudURL, { method: "POST", body: JSON.stringify(db) });
            document.getElementById('syncStatus').innerText = "âœ… Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø­Ø¯Ø«Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"; }
    }

    async function loadFromCloud() {
        try {
            let res = await fetch(cloudURL);
            let data = await res.json();
            if (data && data.classes) { db = data; saveLocally(); updateSelectors(); }
            document.getElementById('syncStatus').innerText = "âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ"; }
    }

    function saveLocally() { localStorage.setItem('abs_v_pro_manage', JSON.stringify(db)); }
    function save() { saveLocally(); syncToCloud(); }

    // --- Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø·Ù„Ø§Ø¨) ---
    function renderManageTable() {
        const cls = document.getElementById('manageClassSel').value;
        const area = document.getElementById('manageTableArea');
        if(!cls) return area.innerHTML = "";

        let h = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
        db.classes[cls].forEach((st, index) => {
            h += `<tr>
                <td><input type="text" value="${st.name}" onchange="updateStudentData('${cls}', ${index}, 'name', this.value)"></td>
                <td><input type="tel" value="${st.phone}" onchange="updateStudentData('${cls}', ${index}, 'phone', this.value)"></td>
                <td><button class="btn-sm btn-red" onclick="deleteStudent('${cls}', ${index})">Ø­Ø°Ù</button></td>
            </tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function updateStudentData(cls, index, field, value) {
        db.classes[cls][index][field] = value.trim();
        save();
    }

    function deleteStudent(cls, index) {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            db.classes[cls].splice(index, 1);
            save();
            renderManageTable();
        }
    }

    function deleteWholeClass() {
        const cls = document.getElementById('manageClassSel').value;
        if(!cls) return;
        if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØµÙ (${cls}) Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø§Ø¨Ù‡ØŸ`)) {
            delete db.classes[cls];
            save();
            updateSelectors();
            renderManageTable();
        }
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ---
    function renderStudents() {
        const cls = document.getElementById('classSel').value;
        const area = document.getElementById('gridArea');
        if(!cls) return;
        document.getElementById('footerAction').style.display = "block";
        area.innerHTML = '<div class="student-grid"></div>';
        db.classes[cls].forEach(st => {
            const d = document.createElement('div'); d.className = 'student-card'; d.innerHTML = `<strong>${st.name}</strong>`;
            d.onclick = () => d.classList.toggle('selected');
            area.querySelector('.student-grid').appendChild(d);
        });
    }

    function saveAbsenceOnly() {
        const sel = document.querySelectorAll('.student-card.selected');
        const cls = document.getElementById('classSel').value;
        const today = new Date().toLocaleDateString('ar-EG');
        sel.forEach(card => {
            const name = card.querySelector('strong').innerText;
            const st = db.classes[cls].find(s => s.name === name);
            db.archive.push({ ...st, class: cls, date: today, ts: Date.now() + Math.random() });
        });
        save(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­"); location.reload();
    }

    function updateSelectors() {
        ['classSel', 'reportClassSel', 'manageClassSel'].forEach(id => {
            const s = document.getElementById(id); if(!s) return;
            const currentVal = s.value;
            s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>';
            Object.keys(db.classes).sort().forEach(c => s.innerHTML += `<option value="${c}" ${c===currentVal?'selected':''}>${c}</option>`);
        });
    }

    function addBulk() {
        const name = document.getElementById('newClsName').value;
        const raw = document.getElementById('bulkPaste').value;
        if(!name || !raw) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨");
        db.classes[name] = raw.split('\n').filter(l => l.trim()).map(line => {
            const p = line.split(/[\s,ØŒ\t]+(?=\d)/);
            return { name: p[0].trim(), phone: p[1] ? p[1].trim() : "" };
        });
        save(); alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ Ø¨Ù†Ø¬Ø§Ø­"); updateSelectors();
    }

    function updateSettings() {
        db.teacherPin = document.getElementById('teacherPassEdit').value;
        db.adminPin = document.getElementById('adminPassEdit').value;
        db.template = document.getElementById('msgTemplate').value;
        save(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
    }

    function accessControl(tab) { targetTab = tab; document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById('loginPage').classList.add('active'); }
    
    function verifyAccess() {
        const pin = document.getElementById('passInput').value;
        if (pin === db.adminPin) showTab('admin');
        else if (pin === db.teacherPin) showTab('home');
        else alert("Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­");
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        updateSelectors();
        if(id === 'admin') {
            document.getElementById('teacherPassEdit').value = db.teacherPin;
            document.getElementById('adminPassEdit').value = db.adminPin;
            document.getElementById('msgTemplate').value = db.template;
        }
        if(id === 'home') document.getElementById('dayDisplay').innerText = `ğŸ“ ØºÙŠØ§Ø¨ ${new Date().toLocaleDateString('ar-EG')}`;
    }

    // (Ø¨Ù‚ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ)
    function generateClassReport() {
        const cls = document.getElementById('reportClassSel').value;
        const area = document.getElementById('classReportArea');
        if(!cls) return;
        let h = `<table><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th></tr>`;
        db.classes[cls].forEach((st, i) => {
            const abs = db.archive.filter(a => a.name === st.name && a.class === cls);
            h += `<tr onclick="toggleD(${i})"><td>${st.name}</td><td><span class="btn-sm btn-red">${abs.length}</span></td></tr>
            <tr><td colspan="2"><div id="d-${i}" class="absence-details">${abs.map(a => `<div>${a.date} <button class="btn-sm btn-red" onclick="delR(${a.ts})">ğŸ—‘ï¸</button></div>`).join('')}</div></td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }
    function toggleD(i) { const el = document.getElementById(`d-${i}`); el.style.display = el.style.display==='block'?'none':'block'; }
    function delR(ts) { if(confirm("Ø­Ø°ÙØŸ")) { db.archive = db.archive.filter(a => a.ts !== ts); save(); generateClassReport(); } }
    
    function loadAdminMessenger() {
        const area = document.getElementById('adminMessenger');
        const dIn = document.getElementById('historyDateSelector').value;
        if(!dIn) return;
        const locD = new Date(dIn).toLocaleDateString('ar-EG');
        const dayAbs = db.archive.filter(a => a.date === locD);
        if(dayAbs.length === 0) return area.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨";
        let h = `<table><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ù…Ø±Ø§Ø³Ù„Ø©</th></tr>`;
        dayAbs.forEach(st => {
            h += `<tr><td>${st.name}</td><td>
            <button class="btn-sm btn-green" onclick="sendMsg('${st.name}','${st.phone}','wa')">WA</button>
            <button class="btn-sm btn-orange" onclick="sendMsg('${st.name}','${st.phone}','sms')">SMS</button></td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }
    function sendMsg(name, phone, type) {
        let msg = db.template.replace('[name]', name);
        if(type === 'wa') window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(msg)}`);
        else window.location.href = `sms:${phone}?body=${encodeURIComponent(msg)}`;
    }
    function renderChart(type) {
        const ctx = document.getElementById('absChart').getContext('2d');
        if (myChart) myChart.destroy();
        const labels = Object.keys(db.classes);
        const dataValues = labels.map(cls => {
            return db.archive.filter(rec => {
                const parts = rec.date.split('/');
                const recDate = new Date(parts[2], parts[1] - 1, parts[0]);
                const diffDays = (new Date() - recDate) / (1000 * 60 * 60 * 24);
                return rec.class === cls && (type === 'week' ? diffDays <= 7 : diffDays <= 30);
            }).length;
        });
        myChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: `ØºÙŠØ§Ø¨ ${type==='week'?'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':'Ø´Ù‡Ø±ÙŠ'}`, data: dataValues, backgroundColor: '#0ea5e9' }] } });
    }

    window.onload = loadFromCloud;
</script>
</body>
</html>
