<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ - Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sky-main: #0ea5e9; --sky-light: #f0f9ff; --sky-dark: #0369a1; --absent: #ef4444; --wa-green: #25D366; --edit: #f59e0b; --sms-blue: #3b82f6; --gray-done: #64748b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--sky-light); margin: 0; padding: 10px; padding-bottom: 80px; direction: rtl; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border-bottom: 4px solid var(--sky-main); position: relative; }
        .school-info { margin-top: 10px; color: #475569; line-height: 1.6; font-size: 14px; border-top: 1px solid #f1f5f9; padding-top: 10px; }
        .nav-buttons { display: flex; justify-content: space-between; position: absolute; top: 15px; width: calc(100% - 40px); left: 20px; }
        .nav-link { color: var(--sky-dark); cursor: pointer; font-weight: bold; font-size: 13px; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--sky-main); background: #fff; }
        .section { display: none; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; box-sizing: border-box; }
        .btn { background: var(--sky-dark); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 15px; margin-top: 5px; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 12px; margin: 2px; border-radius: 8px; cursor: pointer; border: none; color: white; }
        .btn-green { background: var(--wa-green); }
        .btn-red { background: var(--absent); }
        .btn-orange { background: var(--edit); }
        .btn-sms { background: var(--sms-blue); }
        .btn-done { background: var(--gray-done) !important; opacity: 0.7; cursor: default; }
        .box-blue { background: #f0f9ff; padding: 15px; border-radius: 15px; border: 1px solid #bae6fd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f8fafc; color: var(--sky-dark); }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .student-card { padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; text-align: center; cursor: pointer; background: white; }
        .student-card.selected { background: #fee2e2; border-color: var(--absent); color: var(--absent); font-weight: bold; }
        
        @media print {
            .no-print, .btn, .btn-sm, .nav-link, .nav-buttons, input, select, canvas { display: none !important; }
            body { background: white; padding: 0; }
            header { border: none; box-shadow: none; padding: 0; margin-bottom: 20px; }
            .section { display: block !important; box-shadow: none; padding: 0; }
            table { font-size: 14px; width: 100%; border: 1px solid black; }
            th, td { border: 1px solid black; color: black !important; }
        }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; padding: 12px 0; text-align: center; font-size: 14px; z-index: 1000; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="nav-buttons no-print">
            <span class="nav-link" onclick="accessControl('admin')">âš™ï¸Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
            <span class="nav-link" onclick="accessControl('home')">ğŸ“ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</span>
        </div>
        <h2 style="margin:0; color:var(--sky-dark); font-size: 22px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h2>
        <div class="school-info">
            <strong>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</strong><br>
            Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø¨Ù…Ø­Ø§ÙØ¸Ø© Ø´Ù…Ø§Ù„ Ø§Ù„Ø¨Ø§Ø·Ù†Ø©<br>
            Ù…Ø¯Ø±Ø³Ø© Ø³Ø¹ÙŠØ¯ Ø¨Ù† Ø³Ù„Ø·Ø§Ù† (9-12)<br>
            Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <strong>Ø£. Ø³Ø¹ÙŠØ¯ Ø¨Ù† Ø³Ù„ÙŠÙ…Ø§Ù† Ø§Ù„Ø¨Ø§Ø¯ÙŠ</strong>
        </div>
    </header>

    <div id="syncStatus" class="no-print" style="text-align: center; font-size: 11px; font-weight: bold; margin-bottom: 10px; color: #0369a1;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù†...</div>

    <div id="loginPage" class="section active no-print" style="text-align: center;">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="max-width:250px"><br>
        <button class="btn" style="max-width:250px" onclick="verifyAccess()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="home" class="section no-print">
        <h3 id="dayDisplay">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
        <select id="classSel" onchange="renderStudents()"></select>
        <div id="gridArea"></div>
        <div id="footerAction" style="display:none;">
            <button class="btn" onclick="saveAbsenceOnly()">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© â˜ï¸</button>
        </div>
    </div>

    <div id="admin" class="section">
        
        <div class="box-blue no-print">
            <h4 style="margin-top:0;">âœï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨</h4>
            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom:10px;">
                <select id="manageClassSel" onchange="renderManageTable()" style="flex: 2; min-width: 150px;"></select>
                <input type="text" id="renameClassInput" placeholder="ØªØºÙŠÙŠØ± Ù…Ø³Ù…Ù‰ Ø§Ù„ØµÙ" style="flex: 1; min-width: 150px;">
                <button class="btn-sm btn-orange" onclick="renameClass()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ù…Ù‰</button>
                <button class="btn-sm btn-red" onclick="deleteWholeClass()">Ø­Ø°Ù Ø§Ù„ØµÙ</button>
            </div>
            <div id="manageTableArea" style="overflow-x: auto;"></div>
        </div>

        <div class="box-blue no-print">
            <h4>â• Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="newClsName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ (Ù…Ø«Ø§Ù„: 5/1)">
            <textarea id="bulkPaste" rows="3" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§ (Ø§Ù„Ø§Ø³Ù… Ø«Ù… Ù…Ø³Ø§ÙØ© Ø«Ù… Ø§Ù„Ø±Ù‚Ù…)"></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="addBulk()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
        </div>

        <div class="box-blue">
            <h4 class="no-print">ğŸ“¬ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h4>
            <div style="display:flex; gap:10px;" class="no-print">
                <input type="date" id="historyDateSelector" onchange="loadAdminMessenger()" style="max-width: 200px;">
                <button class="btn-sm btn-orange" onclick="window.print()" style="padding: 0 20px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
            </div>
            <div id="adminMessenger"></div>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ“Š Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„ØºÙŠØ§Ø¨</h4>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-sm btn-orange" onclick="renderChart('week')">Ø¥Ø­ØµØ§Ø¡ Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                <button class="btn-sm btn-orange" onclick="renderChart('month')">Ø¥Ø­ØµØ§Ø¡ Ø´Ù‡Ø±ÙŠ</button>
            </div>
            <canvas id="absChart" style="max-height: 250px;"></canvas>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ“ˆ Ø£Ø±Ø´ÙŠÙ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙÙˆÙ</h4>
            <select id="reportClassSel" onchange="generateClassReport()"></select>
            <div id="classReportArea"></div>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
            <input type="text" id="teacherPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="adminPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
            <textarea id="msgTemplate" rows="2" placeholder="Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="updateSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>
</div>

<footer class="no-print">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: <strong>Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ/95367258</strong></footer>

<script>
    const cloudURL = "https://script.google.com/macros/s/AKfycbz21Hf8IdV6w4sIXXEo3ajFdKon173UO2-iXBu1g5lAY2qsFF8-u_8VqHrJMV-bgrINnA/exec"; 
    
    let db = JSON.parse(localStorage.getItem('abs_v_pro_full_v4')) || { 
        classes: {}, adminPin: "1122", teacherPin: "1234", archive: [],
        template: "Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨: [name] Ø§Ù„ÙŠÙˆÙ…ØŒ Ù†Ø±Ø¬Ùˆ Ù…Ù†ÙƒÙ… Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© - Ù…Ø¯Ø±Ø³Ø© Ø³Ø¹ÙŠØ¯ Ø¨Ù† Ø³Ù„Ø·Ø§Ù† Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù„Ù‰ 92592980"
    };

    let myChart = null;

    async function syncToCloud() {
        document.getElementById('syncStatus').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹...";
        try {
            await fetch(cloudURL, { method: "POST", body: JSON.stringify(db) });
            document.getElementById('syncStatus').innerText = "âœ… Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø­Ø¯Ø«Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ²Ø§Ù…Ù†"; }
    }

    async function loadFromCloud() {
        try {
            let res = await fetch(cloudURL);
            let data = await res.json();
            if (data && data.classes) { 
                db = data; 
                localStorage.setItem('abs_v_pro_full_v4', JSON.stringify(db)); 
                updateSelectors(); 
            }
            document.getElementById('syncStatus').innerText = "âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ"; }
    }

    function save() { localStorage.setItem('abs_v_pro_full_v4', JSON.stringify(db)); syncToCloud(); }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ØµÙÙˆÙ ---
    function renderManageTable() {
        const cls = document.getElementById('manageClassSel').value;
        const area = document.getElementById('manageTableArea');
        if(!cls) return area.innerHTML = "";
        let h = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø­Ø°Ù</th></tr>`;
        db.classes[cls].forEach((st, index) => {
            h += `<tr>
                <td><input type="text" value="${st.name}" onchange="db.classes['${cls}'][${index}].name=this.value; save()"></td>
                <td><input type="tel" value="${st.phone}" onchange="db.classes['${cls}'][${index}].phone=this.value; save()"></td>
                <td><button class="btn-sm btn-red" onclick="db.classes['${cls}'].splice(${index},1); save(); renderManageTable()">âŒ</button></td>
            </tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function renameClass() {
        const oldN = document.getElementById('manageClassSel').value;
        const newN = document.getElementById('renameClassInput').value.trim();
        if(oldN && newN && !db.classes[newN]) {
            db.classes[newN] = db.classes[oldN];
            delete db.classes[oldN];
            db.archive.forEach(r => { if(r.class === oldN) r.class = newN; });
            save(); updateSelectors(); alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        }
    }

    function deleteWholeClass() {
        const cls = document.getElementById('manageClassSel').value;
        if(cls && confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
            delete db.classes[cls];
            save(); updateSelectors(); renderManageTable();
        }
    }

    function addBulk() {
        const name = document.getElementById('newClsName').value;
        const raw = document.getElementById('bulkPaste').value;
        if(!name || !raw) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨");
        db.classes[name] = raw.split('\n').filter(l => l.trim()).map(line => {
            const p = line.split(/[\s,ØŒ\t]+(?=\d)/);
            return { name: p[0].trim(), phone: p[1] ? p[1].trim() : "" };
        });
        save(); updateSelectors(); alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
    }

    // --- Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
    function loadAdminMessenger() {
        const area = document.getElementById('adminMessenger');
        const dIn = document.getElementById('historyDateSelector').value;
        if(!dIn) return;
        const locD = new Date(dIn).toLocaleDateString('ar-EG');
        const dayAbs = db.archive.filter(a => a.date === locD);
        if(dayAbs.length === 0) return area.innerHTML = "<p style='text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨</p>";
        let h = `<h3 style="text-align:center">ÙƒØ´Ù ØºÙŠØ§Ø¨ ÙŠÙˆÙ…: ${locD}</h3><table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th class="no-print">Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©</th></tr>`;
        dayAbs.forEach(st => {
            const isSent = st.sent === true;
            h += `<tr><td>${st.name}</td><td>${st.class}</td><td class="no-print">
                <button class="btn-sm ${isSent ? 'btn-done' : 'btn-green'}" onclick="sendAndSync(this, ${st.ts}, '${st.name}', '${st.phone}', 'wa')">${isSent ? 'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©' : 'ÙˆØ§ØªØ³Ø§Ø¨'}</button>
                <button class="btn-sm ${isSent ? 'btn-done' : 'btn-sms'}" onclick="sendAndSync(this, ${st.ts}, '${st.name}', '${st.phone}', 'sms')">${isSent ? 'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©' : 'SMS'}</button>
            </td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function sendAndSync(btn, ts, name, phone, type) {
        const record = db.archive.find(a => a.ts === ts);
        if (record) { record.sent = true; save(); }
        btn.className = "btn-sm btn-done"; btn.innerText = "ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©";
        let msg = db.template.replace('[name]', name);
        if(type === 'wa') window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(msg)}`);
        else window.location.href = `sms:${phone}?body=${encodeURIComponent(msg)}`;
    }

    // --- Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
    function renderChart(type) {
        const ctx = document.getElementById('absChart').getContext('2d');
        if (myChart) myChart.destroy();
        const labels = Object.keys(db.classes);
        const dataValues = labels.map(cls => {
            return db.archive.filter(rec => {
                const parts = rec.date.split('/');
                const recDate = new Date(parts[2], parts[1] - 1, parts[0]);
                const diffDays = (new Date() - recDate) / (1000 * 60 * 60 * 24);
                return rec.class === cls && (type === 'week' ? diffDays <= 7 : diffDays <= 30);
            }).length;
        });
        myChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: `Ø¹Ø¯Ø¯ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ (${type==='week'?'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':'Ø´Ù‡Ø±ÙŠ'})`, data: dataValues, backgroundColor: '#0ea5e9' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© ---
    function renderStudents() {
        const cls = document.getElementById('classSel').value;
        const area = document.getElementById('gridArea');
        if(!cls) return;
        document.getElementById('footerAction').style.display = "block";
        area.innerHTML = '<div class="student-grid"></div>';
        db.classes[cls].forEach(st => {
            const d = document.createElement('div'); d.className = 'student-card'; d.innerHTML = `<strong>${st.name}</strong>`;
            d.onclick = () => d.classList.toggle('selected');
            area.querySelector('.student-grid').appendChild(d);
        });
    }

    function saveAbsenceOnly() {
        const sel = document.querySelectorAll('.student-card.selected');
        const cls = document.getElementById('classSel').value;
        const today = new Date().toLocaleDateString('ar-EG');
        sel.forEach(card => {
            const name = card.querySelector('strong').innerText;
            const st = db.classes[cls].find(s => s.name === name);
            db.archive.push({ ...st, class: cls, date: today, ts: Date.now() + Math.random(), sent: false });
        });
        save(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­"); location.reload();
    }

    function updateSelectors() {
        ['classSel', 'reportClassSel', 'manageClassSel'].forEach(id => {
            const s = document.getElementById(id); if(!s) return;
            const cur = s.value;
            s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>';
            Object.keys(db.classes).sort().forEach(c => s.innerHTML += `<option value="${c}" ${c===cur?'selected':''}>${c}</option>`);
        });
    }

    function generateClassReport() {
        const cls = document.getElementById('reportClassSel').value;
        const area = document.getElementById('classReportArea');
        if(!cls) return;
        let h = `<table><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th></tr>`;
        db.classes[cls].forEach((st, i) => {
            const abs = db.archive.filter(a => a.name === st.name && a.class === cls);
            h += `<tr onclick="document.getElementById('dr-${i}').style.display = document.getElementById('dr-${i}').style.display==='block'?'none':'block'"><td>${st.name}</td><td><b>${abs.length}</b></td></tr>
            <tr><td colspan="2"><div id="dr-${i}" style="display:none; padding:5px; font-size:11px;">${abs.map(a => `${a.date} <button class="btn-sm btn-red" onclick="db.archive=db.archive.filter(x=>x.ts!==${a.ts});save();generateClassReport()">Ø­Ø°Ù</button> | `).join('')}</div></td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function updateSettings() {
        db.teacherPin = document.getElementById('teacherPassEdit').value;
        db.adminPin = document.getElementById('adminPassEdit').value;
        db.template = document.getElementById('msgTemplate').value;
        save(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    function verifyAccess() {
        const pin = document.getElementById('passInput').value;
        if (pin === db.adminPin) showTab('admin');
        else if (pin === db.teacherPin) showTab('home');
        else alert("Ø§Ù„Ø±Ù…Ø² Ø®Ø·Ø£");
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        updateSelectors();
        if(id === 'admin') {
            document.getElementById('teacherPassEdit').value = db.teacherPin;
            document.getElementById('adminPassEdit').value = db.adminPin;
            document.getElementById('msgTemplate').value = db.template;
            renderChart('week');
        }
    }

    function accessControl(tab) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById('loginPage').classList.add('active'); }
    
    window.onload = loadFromCloud;
</script>
</body>
</html>
