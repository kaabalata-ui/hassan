<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sky-main: #0ea5e9; --sky-light: #f0f9ff; --sky-dark: #0369a1; --absent: #ef4444; --wa-green: #25D366; --edit: #f59e0b; --sms-blue: #3b82f6; --gray-done: #64748b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--sky-light); margin: 0; padding: 10px; padding-bottom: 80px; direction: rtl; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--sky-main); }
        .nav-link { color: var(--sky-dark); cursor: pointer; font-weight: bold; font-size: 13px; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--sky-main); background: #fff; }
        .section { display: none; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; outline: none; box-sizing: border-box; }
        .btn { background: var(--sky-dark); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 15px; margin-top: 5px; }
        .btn-sm { width: auto; padding: 5px 10px; font-size: 12px; margin: 2px; border-radius: 8px; cursor: pointer; border: none; color: white; }
        .btn-green { background: var(--wa-green); }
        .btn-red { background: var(--absent); }
        .btn-orange { background: var(--edit); }
        .btn-sms { background: var(--sms-blue); }
        .btn-done { background: var(--gray-done) !important; opacity: 0.8; }
        .box-blue { background: #f0f9ff; padding: 15px; border-radius: 15px; border: 1px solid #bae6fd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f8fafc; color: var(--sky-dark); }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; }
        .student-card { padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; text-align: center; cursor: pointer; background: white; }
        .student-card.selected { background: #fee2e2; border-color: var(--absent); color: var(--absent); font-weight: bold; }
        
        @media print {
            .no-print, header, footer, .btn, .btn-sm, .nav-link, input, select { display: none !important; }
            body { background: white; padding: 0; }
            .section { display: block !important; box-shadow: none; padding: 0; }
            .box-blue { border: none; background: white; }
            table { font-size: 16px; width: 100%; border: 1px solid black; }
            th, td { border: 1px solid black; }
        }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; padding: 12px 0; text-align: center; font-size: 14px; z-index: 1000; }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <span class="nav-link" onclick="accessControl('admin')">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
        <h2 style="margin:0; color:var(--sky-dark); font-size: 18px;">Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h2>
        <span class="nav-link" onclick="accessControl('home')">ğŸ“ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
    </header>

    <div id="syncStatus" class="no-print" style="text-align: center; font-size: 11px; font-weight: bold; margin-bottom: 10px; color: #0369a1;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©...</div>

    <div id="loginPage" class="section active no-print" style="text-align: center;">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="max-width:250px"><br>
        <button class="btn" style="max-width:250px" onclick="verifyAccess()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="home" class="section no-print">
        <h3 id="dayDisplay">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
        <select id="classSel" onchange="renderStudents()"></select>
        <div id="gridArea"></div>
        <div id="footerAction" style="display:none;">
            <button class="btn" onclick="saveAbsenceOnly()">Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ â˜ï¸</button>
        </div>
    </div>

    <div id="admin" class="section">
        
        <div class="box-blue no-print">
            <h4 style="margin-top:0;">âœï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ø·Ù„Ø§Ø¨</h4>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <select id="manageClassSel" onchange="renderManageTable()" style="flex: 2; min-width: 150px;"></select>
                <input type="text" id="renameClassInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯" style="flex: 1; min-width: 150px;">
                <button class="btn-sm btn-orange" onclick="renameClass()">ØªØºÙŠÙŠØ± Ù…Ø³Ù…Ù‰ Ø§Ù„ØµÙ</button>
                <button class="btn-sm btn-red" onclick="deleteWholeClass()">Ø­Ø°Ù Ø§Ù„ØµÙ</button>
            </div>
            <div id="manageTableArea" style="overflow-x: auto; margin-top: 10px;"></div>
        </div>

        <div class="box-blue" id="printArea">
            <h4 class="no-print">ğŸ“¬ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h4>
            <div style="display:flex; gap:10px;" class="no-print">
                <input type="date" id="historyDateSelector" onchange="loadAdminMessenger()" style="max-width: 200px;">
                <button class="btn-sm btn-orange" onclick="window.print()" style="padding: 0 20px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
            </div>
            <div id="adminMessenger"></div>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h4>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-sm btn-orange" onclick="renderChart('week')">Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="btn-sm btn-orange" onclick="renderChart('month')">Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø´Ù‡Ø±</button>
            </div>
            <canvas id="absChart" style="max-height: 250px;"></canvas>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ“ˆ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø­Ø°Ù Ø£ÙŠØ§Ù… Ù…Ø­Ø¯Ø¯Ø©)</h4>
            <select id="reportClassSel" onchange="generateClassReport()"></select>
            <div id="classReportArea"></div>
        </div>

        <div class="box-blue no-print">
            <h4>â• Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="newClsName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <textarea id="bulkPaste" rows="3" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ù‚Ù…..."></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="addBulk()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ</button>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ” Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ù…ÙˆØ²</h4>
            <input type="text" id="teacherPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="adminPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
            <textarea id="msgTemplate" rows="2" placeholder="Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="updateSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
    </div>
</div>

<footer class="no-print">Ø¥Ø¹Ø¯Ø§Ø¯: <strong>Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ-95367258</strong></footer>

<script>
    const cloudURL = "https://script.google.com/macros/s/AKfycbz21Hf8IdV6w4sIXXEo3ajFdKon173UO2-iXBu1g5lAY2qsFF8-u_8VqHrJMV-bgrINnA/exec"; 
    
    let db = JSON.parse(localStorage.getItem('abs_v_pro_print')) || { 
        classes: {}, adminPin: "1122", teacherPin: "1234", archive: [],
        template: "Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨: [name] Ø§Ù„ÙŠÙˆÙ…."
    };

    let myChart = null;

    async function syncToCloud() {
        document.getElementById('syncStatus').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...";
        try {
            await fetch(cloudURL, { method: "POST", body: JSON.stringify(db) });
            document.getElementById('syncStatus').innerText = "âœ… Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø­Ø¯Ø«Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©"; }
    }

    async function loadFromCloud() {
        try {
            let res = await fetch(cloudURL);
            let data = await res.json();
            if (data && data.classes) { db = data; localStorage.setItem('abs_v_pro_print', JSON.stringify(db)); updateSelectors(); }
            document.getElementById('syncStatus').innerText = "âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ"; }
    }

    function save() { localStorage.setItem('abs_v_pro_print', JSON.stringify(db)); syncToCloud(); }

    // --- Ù…ÙŠØ²Ø© ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³Ù…Ù‰ Ø§Ù„ØµÙ ---
    function renameClass() {
        const oldName = document.getElementById('manageClassSel').value;
        const newName = document.getElementById('renameClassInput').value.trim();
        if(!oldName || !newName) return alert("Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯");
        if(db.classes[newName]) return alert("Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

        db.classes[newName] = db.classes[oldName];
        delete db.classes[oldName];
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        db.archive.forEach(rec => { if(rec.class === oldName) rec.class = newName; });

        save();
        updateSelectors();
        renderManageTable();
        alert("ØªÙ… ØªØºÙŠÙŠØ± Ù…Ø³Ù…Ù‰ Ø§Ù„ØµÙ Ø¨Ù†Ø¬Ø§Ø­");
    }

    // --- ÙƒØ´Ù Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø« Ù…Ø¹ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµÙ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
    function loadAdminMessenger() {
        const area = document.getElementById('adminMessenger');
        const dIn = document.getElementById('historyDateSelector').value;
        if(!dIn) return;
        const locD = new Date(dIn).toLocaleDateString('ar-EG');
        const dayAbs = db.archive.filter(a => a.date === locD);
        
        if(dayAbs.length === 0) return area.innerHTML = "<p style='text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙŠØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</p>";

        let h = `<h3 style="text-align:center">ÙƒØ´Ù ØºÙŠØ§Ø¨ ÙŠÙˆÙ…: ${locD}</h3>`;
        h += `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th class="no-print">Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©</th></tr>`;
        
        dayAbs.forEach(st => {
            h += `<tr>
                <td style="text-align:right">${st.name}</td>
                <td>${st.class}</td>
                <td class="no-print">
                    <button class="btn-sm btn-green" onclick="markDone(this); sendMsg('${st.name}','${st.phone}','wa')">ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button class="btn-sm btn-sms" onclick="markDone(this); sendMsg('${st.name}','${st.phone}','sms')">SMS</button>
                </td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function markDone(btn) {
        btn.classList.add('btn-done');
        btn.innerText = "ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©";
    }

    // --- Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    function renderManageTable() {
        const cls = document.getElementById('manageClassSel').value;
        const area = document.getElementById('manageTableArea');
        if(!cls) return area.innerHTML = "";
        let h = `<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;
        db.classes[cls].forEach((st, index) => {
            h += `<tr>
                <td><input type="text" value="${st.name}" onchange="db.classes['${cls}'][${index}].name=this.value; save()"></td>
                <td><input type="tel" value="${st.phone}" onchange="db.classes['${cls}'][${index}].phone=this.value; save()"></td>
                <td><button class="btn-sm btn-red" onclick="db.classes['${cls}'].splice(${index},1); save(); renderManageTable()">Ø­Ø°Ù</button></td>
            </tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function deleteWholeClass() {
        const cls = document.getElementById('manageClassSel').value;
        if(cls && confirm("Ø­Ø°Ù Ø§Ù„ØµÙØŸ")) { delete db.classes[cls]; save(); updateSelectors(); renderManageTable(); }
    }

    function renderStudents() {
        const cls = document.getElementById('classSel').value;
        const area = document.getElementById('gridArea');
        if(!cls) return;
        document.getElementById('footerAction').style.display = "block";
        area.innerHTML = '<div class="student-grid"></div>';
        db.classes[cls].forEach(st => {
            const d = document.createElement('div'); d.className = 'student-card'; d.innerHTML = `<strong>${st.name}</strong>`;
            d.onclick = () => d.classList.toggle('selected');
            area.querySelector('.student-grid').appendChild(d);
        });
    }

    function saveAbsenceOnly() {
        const sel = document.querySelectorAll('.student-card.selected');
        const cls = document.getElementById('classSel').value;
        const today = new Date().toLocaleDateString('ar-EG');
        sel.forEach(card => {
            const name = card.querySelector('strong').innerText;
            const st = db.classes[cls].find(s => s.name === name);
            db.archive.push({ ...st, class: cls, date: today, ts: Date.now() + Math.random() });
        });
        save(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­"); location.reload();
    }

    function updateSelectors() {
        ['classSel', 'reportClassSel', 'manageClassSel'].forEach(id => {
            const s = document.getElementById(id); if(!s) return;
            const currentVal = s.value;
            s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>';
            Object.keys(db.classes).sort().forEach(c => s.innerHTML += `<option value="${c}" ${c===currentVal?'selected':''}>${c}</option>`);
        });
    }

    function addBulk() {
        const name = document.getElementById('newClsName').value;
        const raw = document.getElementById('bulkPaste').value;
        if(!name || !raw) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        db.classes[name] = raw.split('\n').filter(l => l.trim()).map(line => {
            const p = line.split(/[\s,ØŒ\t]+(?=\d)/);
            return { name: p[0].trim(), phone: p[1] ? p[1].trim() : "" };
        });
        save(); updateSelectors(); alert("ØªÙ…");
    }

    function updateSettings() {
        db.teacherPass = document.getElementById('teacherPassEdit').value;
        db.adminPin = document.getElementById('adminPassEdit').value;
        db.template = document.getElementById('msgTemplate').value;
        save(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    function verifyAccess() {
        const pin = document.getElementById('passInput').value;
        if (pin === db.adminPin) showTab('admin');
        else if (pin === db.teacherPin) showTab('home');
        else alert("Ø®Ø·Ø£!");
    }

    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        updateSelectors();
        if(id === 'admin') {
            document.getElementById('teacherPassEdit').value = db.teacherPin;
            document.getElementById('adminPassEdit').value = db.adminPin;
            document.getElementById('msgTemplate').value = db.template;
        }
        if(id === 'home') document.getElementById('dayDisplay').innerText = `ğŸ“ ØºÙŠØ§Ø¨ ${new Date().toLocaleDateString('ar-EG')}`;
    }

    function sendMsg(name, phone, type) {
        let msg = db.template.replace('[name]', name);
        if(type === 'wa') window.open(`https://api.whatsapp.com/send?phone=${phone}&text=${encodeURIComponent(msg)}`);
        else window.location.href = `sms:${phone}?body=${encodeURIComponent(msg)}`;
    }

    function generateClassReport() {
        const cls = document.getElementById('reportClassSel').value;
        const area = document.getElementById('classReportArea');
        if(!cls) return;
        let h = `<table><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th></tr>`;
        db.classes[cls].forEach((st, i) => {
            const abs = db.archive.filter(a => a.name === st.name && a.class === cls);
            h += `<tr onclick="document.getElementById('d-${i}').style.display = document.getElementById('d-${i}').style.display==='block'?'none':'block'"><td>${st.name}</td><td><span class="btn-sm btn-red">${abs.length}</span></td></tr>
            <tr><td colspan="2"><div id="d-${i}" style="display:none; background:#f8fafc; padding:5px;">${abs.map(a => `<div>${a.date} <button class="btn-sm btn-red" onclick="db.archive = db.archive.filter(x => x.ts !== ${a.ts}); save(); generateClassReport()">ğŸ—‘ï¸</button></div>`).join('')}</div></td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function accessControl(tab) { document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById('loginPage').classList.add('active'); }
    
    window.onload = loadFromCloud;
</script>
</body>
</html>
