<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ - Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sky-main: #0ea5e9; --sky-light: #f0f9ff; --sky-dark: #0369a1; --absent: #ef4444; --wa-green: #25D366; --edit: #f59e0b; --sms-blue: #3b82f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--sky-light); margin: 0; padding: 10px; padding-bottom: 80px; direction: rtl; }
        .container { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--sky-main); }
        .nav-link { color: var(--sky-dark); cursor: pointer; font-weight: bold; font-size: 13px; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--sky-main); background: #fff; }
        .section { display: none; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); min-height: 500px; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; outline: none; box-sizing: border-box; }
        .btn { background: var(--sky-dark); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 15px; margin-top: 5px; }
        .btn-sm { width: auto; padding: 5px 12px; font-size: 12px; margin: 2px; border-radius: 8px; cursor: pointer; border: none; color: white; }
        .btn-green { background: var(--wa-green); }
        .btn-red { background: var(--absent); }
        .btn-orange { background: var(--edit); }
        .btn-sms { background: var(--sms-blue); }
        .btn-sent { background: #64748b !important; }

        .box-blue { background: #f0f9ff; padding: 15px; border-radius: 15px; border: 1px solid #bae6fd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 14px; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: center; }
        th { background: #f8fafc; color: var(--sky-dark); }
        .absence-details { display: none; background: #fffbeb; padding: 10px; border-radius: 8px; border: 1px dashed #f59e0b; margin: 5px; text-align: right; }
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 15px; }
        .student-card { padding: 15px; border: 2px solid #f1f5f9; border-radius: 12px; text-align: center; cursor: pointer; background: white; }
        .student-card.selected { background: #fee2e2; border-color: var(--absent); color: var(--absent); font-weight: bold; }
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; padding: 12px 0; text-align: center; font-size: 14px; z-index: 1000; }
        #chartContainer { width: 100%; max-width: 600px; margin: 0 auto; height: 300px; }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <span class="nav-link" onclick="accessControl('admin')">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</span>
        <h2 style="margin:0; color:var(--sky-dark)">Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h2>
        <span class="nav-link" onclick="accessControl('home')">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</span>
    </header>

    <div id="syncStatus" style="text-align: center; font-size: 12px; font-weight: bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>

    <div id="loginPage" class="section active" style="text-align: center;">
        <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
        <input type="password" id="passInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="max-width:300px">
        <button class="btn" style="max-width:300px" onclick="verifyAccess()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="home" class="section">
        <h3 id="dayDisplay">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
        <select id="classSel" onchange="renderStudents()"></select>
        <div id="gridArea"></div>
        <div id="footerAction" style="display:none;">
            <button class="btn" onclick="saveAbsenceOnly()">Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ â˜ï¸</button>
        </div>
    </div>

    <div id="admin" class="section">
        
        <div class="box-blue">
            <h4>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ (Ø£Ø³Ø¨ÙˆØ¹ÙŠ / Ø´Ù‡Ø±ÙŠ)</h4>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-sm btn-orange" onclick="renderChart('week')">Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                <button class="btn-sm btn-orange" onclick="renderChart('month')">Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ø´Ù‡Ø±</button>
            </div>
            <div id="chartContainer"><canvas id="absChart"></canvas></div>
        </div>

        <div class="box-blue no-print">
            <h4>âœ‰ï¸ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</h4>
            <p style="font-size:11px; color:gray;">Ø§Ø³ØªØ®Ø¯Ù… <b>[name]</b> Ù„ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
            <textarea id="msgTemplate" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ [name] Ø§Ù„ÙŠÙˆÙ…."></textarea>
            <button class="btn-sm btn-orange" onclick="saveTemplate()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
        </div>

        <div class="box-blue">
            <h4>ğŸ“ˆ ÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ (Ø¹Ø±Ø¶ ÙˆØ­Ø°Ù)</h4>
            <select id="reportClassSel" onchange="generateClassReport()"></select>
            <div id="classReportArea"></div>
        </div>

        <div class="box-blue">
            <h4>ğŸ“¬ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</h4>
            <input type="date" id="historyDateSelector" onchange="loadAdminMessenger()">
            <div id="adminMessenger" style="margin-top:15px;"></div>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø·Ù„Ø§Ø¨ ÙÙ‚Ø·)</h4>
            <div style="display: flex; gap: 10px;">
                <button class="btn-sm btn-green" style="flex:1" onclick="exportStudentsOnly()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                <label class="btn-sm btn-orange" style="flex:1; text-align:center; cursor:pointer;">
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨
                    <input type="file" hidden onchange="importStudentsOnly(this)">
                </label>
            </div>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ’¾ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø´Ø§Ù…Ù„)</h4>
            <div style="display: flex; gap: 10px;">
                <button class="btn-sm btn-green" style="flex:1" onclick="exportBackup()">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø©</button>
                <label class="btn-sm btn-orange" style="flex:1; text-align:center; cursor:pointer;">
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©
                    <input type="file" hidden onchange="importBackup(this)">
                </label>
            </div>
        </div>

        <div class="box-blue no-print">
            <h4>ğŸ”‘ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø³Ø±ÙŠØ©</h4>
            <input type="text" id="teacherPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ù…Ø¹Ù„Ù…">
            <input type="text" id="adminPassEdit" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
            <button class="btn-sm btn-orange" style="width:100%" onclick="updatePins()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù…ÙˆØ²</button>
        </div>

        <div class="box-blue">
            <h4>âœï¸ Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</h4>
            <input type="text" id="clsName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ">
            <textarea id="bulkPaste" rows="2" placeholder="Ø§Ù„Ø§Ø³Ù… Ø«Ù… Ø§Ù„Ø±Ù‚Ù…..."></textarea>
            <button class="btn-sm btn-orange" style="width:100%" onclick="addBulk()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>
</div>

<footer class="no-print">Ø¨ÙˆØ§Ø³Ø·Ø©: <strong>Ø­Ø³Ù† Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ</strong></footer>

<script>
    const cloudURL = "Ø¶Ø¹_Ø±Ø§Ø¨Ø·_Ø¬ÙˆØ¬Ù„_Ù‡Ù†Ø§"; 
    let db = JSON.parse(localStorage.getItem('abs_v_pro_charts')) || { 
        classes: {}, adminPin: "1122", teacherPin: "1234", archive: [],
        template: "Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨: [name] Ø§Ù„ÙŠÙˆÙ…."
    };

    let myChart = null;

    // --- Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
    function renderChart(type) {
        const ctx = document.getElementById('absChart').getContext('2d');
        if (myChart) myChart.destroy();

        const labels = Object.keys(db.classes);
        const dataValues = labels.map(cls => {
            return db.archive.filter(rec => {
                const recDate = parseLocaleDate(rec.date);
                const diffDays = (new Date() - recDate) / (1000 * 60 * 60 * 24);
                return rec.class === cls && (type === 'week' ? diffDays <= 7 : diffDays <= 30);
            }).length;
        });

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨Ø§Øª (${type === 'week' ? 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ' : 'Ø´Ù‡Ø±ÙŠ'})`,
                    data: dataValues,
                    backgroundColor: '#0ea5e9'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function parseLocaleDate(dateStr) {
        const parts = dateStr.split('/');
        return new Date(parts[2], parts[1] - 1, parts[0]);
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ù„Ø¨ ---
    function saveTemplate() {
        db.template = document.getElementById('msgTemplate').value;
        save(); alert("ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
    }

    // --- Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ---
    function loadAdminMessenger() {
        const area = document.getElementById('adminMessenger');
        const dateInput = document.getElementById('historyDateSelector').value;
        if(!dateInput) return;
        const localeDate = new Date(dateInput).toLocaleDateString('ar-EG');
        const dayAbs = db.archive.filter(a => a.date === localeDate);
        if(dayAbs.length === 0) return area.innerHTML = "Ù„Ø§ ØºÙŠØ§Ø¨";

        let h = `<table><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ù…Ø±Ø§Ø³Ù„Ø©</th></tr>`;
        dayAbs.forEach(st => {
            h += `<tr>
                <td style="text-align:right"><strong>${st.name}</strong><br><small>${st.class}</small></td>
                <td><input type="tel" id="phone-${st.ts}" value="${st.phone || ''}" style="width:100px; text-align:center;"></td>
                <td>
                    <button class="btn-sm btn-green" onclick="sendMsg(${st.ts}, '${st.name}', 'wa')">ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button class="btn-sm btn-sms" onclick="sendMsg(${st.ts}, '${st.name}', 'sms')">SMS</button>
                </td>
            </tr>`;
        });
        area.innerHTML = h + "</table>";
    }

    function sendMsg(ts, name, type) {
        const newPhone = document.getElementById(`phone-${ts}`).value;
        const record = db.archive.find(a => a.ts === ts);
        if(record) { record.phone = newPhone; save(); }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨
        let finalMsg = db.template.replace('[name]', name);
        const cleanPhone = newPhone.replace(/\D/g, '');
        
        if(type === 'wa') window.open(`https://api.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(finalMsg)}`, '_blank');
        else window.location.href = `sms:${cleanPhone}?body=${encodeURIComponent(finalMsg)}`;
    }

    // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ø­ÙØ¸ ---
    async function syncToCloud() {
        try {
            await fetch(cloudURL, { method: "POST", body: JSON.stringify(db) });
            document.getElementById('syncStatus').innerText = "âœ… Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù…Ø­Ø¯Ø«Ø©";
        } catch (e) { document.getElementById('syncStatus').innerText = "âš ï¸ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ"; }
    }
    function save() { localStorage.setItem('abs_v_pro_charts', JSON.stringify(db)); syncToCloud(); }

    // --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨ ---
    function exportStudentsOnly() {
        const blob = new Blob([JSON.stringify(db.classes)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Ø·Ù„Ø§Ø¨_Ø­Ø³Ù†_Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ.json`; a.click();
    }
    function importStudentsOnly(input) {
        const reader = new FileReader();
        reader.onload = (e) => { 
            db.classes = {...db.classes, ...JSON.parse(e.target.result)}; 
            save(); alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"); updateSelectors(); 
        };
        reader.readAsText(input.files[0]);
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    function accessControl(tab) { targetTab = tab; document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById('loginPage').classList.add('active'); }
    function verifyAccess() {
        const pin = document.getElementById('passInput').value;
        if ((targetTab === 'admin' && pin === db.adminPin) || (targetTab === 'home' && pin === db.teacherPin)) showTab(targetTab);
        else alert("Ø®Ø·Ø£!");
    }
    function showTab(id) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); 
        updateSelectors();
        if(id === 'admin') { 
            document.getElementById('teacherPassEdit').value = db.teacherPin; 
            document.getElementById('adminPassEdit').value = db.adminPin;
            document.getElementById('msgTemplate').value = db.template;
        }
        if(id === 'home') document.getElementById('dayDisplay').innerText = `ğŸ“ ØºÙŠØ§Ø¨ ${new Date().toLocaleDateString('ar-EG')}`;
    }
    function renderStudents() {
        const cls = document.getElementById('classSel').value;
        const area = document.getElementById('gridArea');
        if(!cls) return;
        document.getElementById('footerAction').style.display = "block";
        area.innerHTML = '<div class="student-grid"></div>';
        db.classes[cls].forEach(st => {
            const d = document.createElement('div'); d.className = 'student-card'; d.innerHTML = `<strong>${st.name}</strong>`;
            d.onclick = () => d.classList.toggle('selected');
            area.querySelector('.student-grid').appendChild(d);
        });
    }
    function saveAbsenceOnly() {
        const sel = document.querySelectorAll('.student-card.selected');
        const cls = document.getElementById('classSel').value;
        const today = new Date().toLocaleDateString('ar-EG');
        sel.forEach(card => {
            const name = card.querySelector('strong').innerText;
            const st = db.classes[cls].find(s => s.name === name);
            db.archive.push({ ...st, class: cls, date: today, ts: Date.now() + Math.random() });
        });
        save(); alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); location.reload();
    }
    function generateClassReport() {
        const cls = document.getElementById('reportClassSel').value;
        const area = document.getElementById('classReportArea');
        if(!cls) return;
        let h = `<table><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th></tr>`;
        db.classes[cls].forEach((st, i) => {
            const abs = db.archive.filter(a => a.name === st.name && a.class === cls);
            h += `<tr onclick="toggleDetails(${i})"><td>${st.name}</td><td><span class="btn-sm btn-red">${abs.length}</span></td></tr>
            <tr><td colspan="2"><div id="details-${i}" class="absence-details">
            ${abs.map(a => `<div>${a.date} <button class="btn-sm btn-red" onclick="deleteRec(${a.ts})">ğŸ—‘ï¸</button></div>`).join('')}
            </div></td></tr>`;
        });
        area.innerHTML = h + "</table>";
    }
    function toggleDetails(i) { const el = document.getElementById(`details-${i}`); el.style.display = el.style.display==='block'?'none':'block'; }
    function deleteRec(ts) { if(confirm("Ø­Ø°ÙØŸ")) { db.archive = db.archive.filter(a => a.ts !== ts); save(); generateClassReport(); } }
    function updatePins() { db.teacherPin = document.getElementById('teacherPassEdit').value; db.adminPin = document.getElementById('adminPassEdit').value; save(); alert("ØªÙ…"); }
    function updateSelectors() {
        ['classSel', 'reportClassSel'].forEach(id => {
            const s = document.getElementById(id); if(!s) return;
            const v = s.value; s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>';
            Object.keys(db.classes).forEach(c => s.innerHTML += `<option value="${c}" ${c===v?'selected':''}>${c}</option>`);
        });
    }
    function addBulk() {
        const name = document.getElementById('clsName').value;
        const raw = document.getElementById('bulkPaste').value;
        if(!name || !raw) return;
        db.classes[name] = raw.split('\n').filter(l => l.trim()).map(line => {
            const p = line.split(/[\s,ØŒ\t]+(?=\d)/);
            return { name: p[0].trim(), phone: p[1] ? p[1].trim() : "" };
        });
        save(); alert("ØªÙ…"); updateSelectors();
    }
    function exportBackup() {
        const blob = new Blob([JSON.stringify(db)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `Ø§Ù„Ù†Ø¸Ø§Ù…_Ø§Ù„Ø´Ø§Ù…Ù„_Ø­Ø³Ù†_Ø§Ù„Ø¨Ø±ÙŠÙƒÙŠ.json`; a.click();
    }
    function importBackup(input) {
        const reader = new FileReader();
        reader.onload = (e) => { db = JSON.parse(e.target.result); save(); location.reload(); };
        reader.readAsText(input.files[0]);
    }
    window.onload = async () => { await loadFromCloud(); };
</script>
</body>
</html>